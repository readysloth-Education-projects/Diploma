\chapter{Создание аппаратного обеспечения}\label{ch:ch1}

В представлении обывателя компьютер (системный блок) состоит из материнской платы,
процессора, оперативной памяти, возможно видеокарты.
Давно прошли те времена, когда пользователям компьютеров приходилось отдельно покупать такие модули расширения,
как, например, математический сопроцессор.
С течением времени все больше ранее внешних модулей становится частью материнской платы или самого процессора.

Но производство аппаратного обеспечения не ограничивается потребительским рынком.
Специфические аппаратные решения требуются отдельным отраслям или организациям.

\begin{figure}[!htbp]
    \centering
    \begin{tikzpicture}[%
        start chain=going below,    % General flow is top-to-bottom
        node distance=6mm and 30mm, % Global setup of box spacing
        line/.style={draw, -latex'},
        every join/.style={line},
        block/.style={draw,
                      on chain,
                      on grid,
                      rectangle,
                      minimum height = 2em}
        ]
            \node [block] (feasibility)
                          {Технико-экономическое обоснование};
            \node [block] (preliminary design) [below=2cm of feasibility]
                          {Предварительныое проектирование};
            \node [block] (prototyping) [below=2cm of preliminary design]
                          {Прототипирование};
            \node [block] (design for manufacturing) [below=2cm of prototyping]
                          {Проектирование для производства и сборки};
            \node [block] (manufacturing) [below=2cm of design for manufacturing]
                          {Производство};

            \draw [line] (feasibility) -- (preliminary design);
            \draw [line] (preliminary design) -- (prototyping);
            \draw [line] (prototyping) -- (design for manufacturing);
            \draw [line] (design for manufacturing) -- (manufacturing);

    \end{tikzpicture}
    \caption{Этапы создания аппаратного обеспечения}\label{fig:hardware-design}
\end{figure}

Создание аппаратного обеспечения трудоемкий процесс, непременно сязанный с созданием прикладного программного обеспечения.
В свою очередь, отсутствие возможности исполнения ПО с использованием АО серьезно усложняет отладку и тестирование конечного продукта.

\section{Эмуляция аппаратного обеспечения}\label{sec:ch1/sec1}

Тезис Чёрча-Тьюринга гласит: любая вычислимая (то есть та,
которая может быть реализована на машине Тьюринга) функция вычислима машиной Тьюринга.
Физический тезис Чёрча-Тьюринга гласит: любая функция, которая может быть вычислена физическим устройством, может быть вычислена машиной Тьюринга.

Существуют различное отношение к тезису Чёрча-Тьюринга.
Некоторые считают, что он может быть доказан, другие говорят, что он служит определением вычислений.
Не смотря на то, что тезис до сих пор не доказан, его верность исходит из того, что любая, открытая на текущий момент
реалистичная модель вычислений доказывала его правоту.

Тезис неразрывно связан с термином "эмуляция".

Эмуляция -- это процесс имитирование поведения одного оборудования и/или программного обеспечения
на другом оборудовании и/или программном обеспечении.

Эмулятор АО может использоваться как для имитирования совершенно другого оборудования, так и того, на котором она проводится.
Например, большое количество принтеров умеет эмулировать линейку LaserJet компании Hewlett-Packard,
так как большая часть ПО разработана как раз под LaserJet.

Эмуляторы аппаратного обеспечения бывают разного назначения:

\paragraph{Симуляторы логики}\label{logic-sim}

Данный вид эмуляторов используется для исследования и верификации аппаратного обеспечения на различных уровнях:
\begin{itemize}
    \item компонентном;
    \item логических вентилей;
    \item регистровых передач;
\end{itemize}

\paragraph{Высокоуровневые эмуляторы}\label{high-level-emu}

Высокоуровневая эмуляция -- это набор методов эмулирования некоторых компонентов целой системы.
Позволяет не исполнять инструкции или производить обработку данных один в один, как на целевом оборудовании,
заменяя "горячие" пути обработки аналогичными по результату.

Одними из первых данный подход был использован в эмуляторах игровых консолей, где команды отрисовки трёхмерной сцены
эмулировались не на процессоре, как все остальное оборудование консоли, а отдавались напрямую
графическому процессору машины, на которой происходил процесс эмуляции.


\paragraph{Эмуляторы процессора}\label{cpu-emu}

Эмулируют конкретную архитектуру процессора, позволяя запускать программы, не предназначенные для физического компьютера.
Зачастую умеют эмулировать не только процессор но и переферийные устройства.


\paragraph{Эмуляторы терминала}\label{term-emu}

Эмулируют терминал компьютера внутри некоторой архитектуры отображения данных на дисплее.


\paragraph{Сэмуляторы}\label{sim-emu}

Являются симбиозом симуляторов и эмуляторов, который берет лучшее от двух миров.
Аппаратное обеспечение описовается HDL языками, после чего данное описание оборудования симулируется на стендах.
Первоначальная функциональная верификация производится через симуляцию на уровне регистровых передач или логических вентилей.
В событийно-ориентированной симуляции инструкции последовательно исполняются процессором, потому что в превалирующем большинстве
сценариев не возможно провести данную симуляцию параллельно. Последовательных подход приводит к долгим симуляциям, особенно в
сложных системах на кристалле.
После симуляции описание регистровых передач должно быть зашито в аппаратное обеспечение (FPGA, ASIC).
Но идеализированное представление аппаратного обеспечения в симуляции отличается от реального аппаратного обеспечения.
Отличие между симуляцией и работой аппаратного обеспечения является серьезной причиной применений эмуляции при
проектировании.
Преимуществом данного метода является:
\begin{itemize}
    \item ускорение симуляции: часть сложной системы, не релевантная для симуляции переносится в эмулятор,
          что позволяет вынести из симуляции нерелевантные части;
    \item использование реального аппаратного обеспечения на ранних этапах проектирования;
\end{itemize}


\section{Аппаратное обеспечение -- физическое и виртуальное}\label{sec:ch1/sec2}

Прикладная польза от эмуляции аппаратного обеспечения может быть достигнута не только
при проектировании и разработке специализированного аппаратного обеспечения, но и, напрмер,
для совместного использования одного физического устройства несколькими компьютерами (в основном
виртуальными машинами).
Представляя аппаратное обеспечение гостевой системе как физическим устройство, можно
свести на нет затраты на написание специализированных драйверов и утилизировать
существующие, вынося обработку совместного использования в реализацию эмулируемого аппаратного обеспечения.

Например, можно запустить некоторое количество виртуальных машин на одной физической, и для каждой
виртуальной машины использование графического ускорителя будет прозрачным, тогда как на самом
деле управлением задачами отрисовки или обработки данных будет заниматься виртуальное устройство.

Также вынесение интерфейса реального устройства в виртуальное позволяет применить общение с программой-посредником,
которая будет отдавать команды реальному устройству или группе устройств.
Например, запускать в виртуальной машине вычисления на виртуальных графических ускорителях, которые
будут, в свою очередь, отдавать задачи обсчета реальным графическим ускорителям где-нибудь в облаке.

Помимо перечисленных выше применений, виртуальные устройства предоставляются некоторыми компаниями
в режиме PaaS -- Platform as Service или "Платформа как услуга", что позволяет другим разработчикам
испльзовать их для удаленного тестирования своих приложений в разных окружениях \cite{lambdatest} \cite{genymotion}.


\section{Создание эмуляторов}\label{sec:ch1/sec3}

Создание эмуляторов -- трудоемкий и затратный процесс. Помимо перечисленных ранее типов эмуляторов особой популярностью
пользуются так же эмуляторы игровых приставок, как старых, так и новых.
Их создание помогает сохранить игры и программы для будущих поколений, формируя целые виртуальные библиотеки, как,
например "Internet Archive"\cite{console-archive}.
С ростом вычислительной мощности усложняется и архитектура современных игровых приставок.
Эмулятор для PlayStation 4 вышел только через восемь лет после выхода самой консоли \cite{ps4-emulator}, и то
он не может запустить всю коллекцию игр, а PlayStation 4 не принадлежит последнему поколению приставок.

Создание эмуляторов какого-либо аппаратного обеспечения укладывается в следующих этапах:

\begin{figure}[!htbp]
    \centering
    \begin{tikzpicture}[%
        start chain=going below,    % General flow is top-to-bottom
        node distance=6mm and 30mm, % Global setup of box spacing
        line/.style={draw, -latex'},
        every join/.style={line},
        block/.style={draw,
                      on chain,
                      on grid,
                      rectangle,
                      minimum height = 2em}
        ]
            \node [block] (subset)
                          {Вычленение эмулируемого подмножества функционала устройства};
            \node [block, fill=yellow] (conversation) [below=2cm of subset]
                          {Выбор и написание средства общения ПО с эмулятором};
            \node [block] (logic) [below=2cm of conversation]
                          {Написание логики эмулятора};

            \draw [line] (subset) -- (conversation);
            \draw [line] (conversation) -- (logic);

    \end{tikzpicture}
    \caption{Этапы создания эмулятора аппаратного обеспечения}\label{fig:emu-creation-naive}
\end{figure}

%\begin{enumerate}[label={\arabic*)}]
%    \item вычленения эмулируемого подмножества функционала устройства;
%    \item выбора и написания средства общения ПО с эмулятором;
%    \item .
%\end{enumerate}

Первый этап является проектировочным и его результат зависит от нужд конкретной реализации, временных ограничений,
соображений о целесообразности.
Второй этап тоже, до некоторой степени, проектировочный, но уже здесь можно принять решение
воспользоваться эмуляторами, которые поддерживают встраивание виртуального аппаратного обеспечения,
что автоматически решит задачу.
Третий этап является полностью практическим.

Облегчить второй и третий этап можно, если решить использовать уже имеющуюся инфраструктуру эмулятора,
встроив в нее эмулируемое аппаратное обеспечение.
Использование имеющейся инфраструктуры задает строгий интерфейс встраивания, что ограничивает и тривиализирует
общение ПО с виртуальным устройством.
Помимо этого, интерфейс встраивания позволяет автоматически генерировать если не всю, то часть взаимодействия
между виртуальным устройством и эмулятором.

Используя данный подход, задача создания эмулятора аппаратного обеспечения трансформируется в следующие этапы:
\begin{figure}[!htbp]
    \centering
    \begin{tikzpicture}[%
        start chain=going below,    % General flow is top-to-bottom
        node distance=6mm and 30mm, % Global setup of box spacing
        line/.style={draw, -latex'},
        every join/.style={line},
        block/.style={draw,
                      on chain,
                      on grid,
                      rectangle,
                      minimum height = 2em}
        ]
            \node [block] (subset)
                          {Вычленение эмулируемого подмножества функционала устройства};
            \node [block, fill=yellow] (conversation) [below=2cm of subset]
                          {Реализация общения виртуального аппаратного обеспечения и эмулятора};
            \node [block, fill=yellow] (driver) [below=2cm of conversation]
                          {Реализация общения ПО с эмулятором (написание драйвера)};
            \node [block] (logic) [below=2cm of driver]
                          {Написание логики эмулятора};

            \draw [line] (subset) -- (conversation);
            \draw [line] (conversation) -- (driver);
            \draw [line] (driver) -- (logic);

    \end{tikzpicture}
    \caption{Этапы создания эмулятора аппаратного обеспечения с использованием существующего эмулятора}\label{fig:emu-creation-pro}
\end{figure}

%\begin{enumerate}[label={\arabic*)}]
%    \item вычленения эмулируемого подмножества функционала устройства;
%    \item реализация общения виртуального аппаратного обеспечения и эмулятора;
%    \item реализация общения ПО с эмулятором (написание драйвера);
%    \item написание логики эмулятора.
%\end{enumerate}

Не смотря на увеличение количества этапов, второй и третий этап данной схемы реализовать проще и
целесообразнее, чем второй этап предыдущей схемы, так как во первом случае
протокол общения прикладного ПО и аппаратного обеспечения будет находиться частично в
эмуляторе аппаратного обеспечения, частично в прикладном ПО.
Тогда как во втором случае протокол это реализации драйвера устройства, который в любом случае придется писать.

Но даже в таком подходе можно облегчить второй и четвертый этапы, для этого не хватает только
генератора, который мог бы самостоятельно встроить будущее виртуальное аппаратное обеспечение
в эмулятор, основываясь на спецификации устройства.
Существование такого генератора не только полностью бы убрало второй этап, но и облегчило последний.
В случае, если есть возможность получить описание работы эмулируемого аппаратного обеспечения на HDL языке,
то четвертый этап создания эмулятора тоже автоматизируется, так как логика работы аппаратного обеспечения
уже описана на HDL языке.


\section{Симуляция HDL}\label{sec:ch1/sec3}

HDL или Harwdare Description Language -- специализированный язык для описания структуры и поведния
электронных схем. Самыми известными и популярными представителями являются Verilog и VHDL.
Данный тип языков помогает разрабатывать электронные схемы на более высоком уровне абстракции, чем раньше,
что просто необходимо при проектировании сложных современных интегральных схем.

Процесс превращения HDL-кода в соединения логических вентилей называется логическим синтезом.
Результат логического синтеза -- список соединений, который может быть зашит на ПЛИС, или исполнен в симуляторе, что позволяет
протестировать HDL-программу не используя ПЛИС.

\begin{figure}[!htbp]
    \centering
    \begin{adjustbox}{max totalsize={0.6\textwidth}{0.6\textheight}}
        \includegraphics[]{images/netlist.png}
    \end{adjustbox}
    \caption{Визуализация результата логического синтеза}\label{fig:emu-creation-pro}
\end{figure}


Так как в списке соединений заложена логика работы устройства, пусть и на элементном уровне,
то его можно использовать для эмуляции работы устройства.


\section{Унифицированный подход к созданию эмуляторов аппаратного обеспечения}\label{sec:ch1/sec4}

Унифицированный подход к созданию эмуляторов аппаратного обеспечения позволяет
повысить степень автоматизации и корректности рутинной работы по внедрению
эмулятора в исполняемую среду. Но сначала надо выбрать эмулятор, который
будет использоваться для эмулирования целевого аппаратного обеспечения.

\subsection{Сравнение эмуляторов с открытым исходным кодом}\label{sec:ch1/sec4/sub1}

Активно развивающихся эмуляторов с открытым исходным кодом мало, Bochs и QEMU
единственные, которые можно было бы использовать для создания на их основе
эмуляторов аппаратного обеспечения.

\begin{table}[!htbp]
    {
        \setlength{\tabcolsep}{2pt}
        \begin{longtable}{*{3}{| c}|}
            \hline
            \diagbox[width=8.5cm]{Свойства}{Название\\эмулятора}                                       &
            \makecell{Bochs} &
            \makecell{QEMU} \\
            \hline
            \makecell{Кроссплатформенность}                         & \greencell{Да}                       & \greencell{Да}      \\
            \hline
            \makecell{Поддержка платформ кроме x86}                 & \redcell{Нет}                        & \greencell{Да}      \\
            \hline
            \makecell{Скорость эмуляции}                            & \redcell{Низкая}                     & \greencell{Высокая} \\
            \hline
            \makecell{Возможность добавить\\собственное устройство} & \yellowcell{Нет удобного интерфейса} & \greencell{Есть}    \\
            \hline
        \end{longtable}
    }
    \bigskip
    \caption{Сравнение эмуляторов Bochs и QEMU}\label{fig:emu-comparsion}
\end{table}

Исходя из таблицы \ref{fig:emu-comparsion}, лучшим эмулятором для поставленной задачи будет QEMU.

\subsection{Методика добавления целевого аппаратного обеспечения в QEMU}\label{sec:ch1/sec4/sub2}

% Написать про устройство QEMU
% Написать про QOM
% Написать про Встраивание в QOM

\subsubsection{Устройство QEMU}\label{sec:ch1/sec4/sub2/sub1}

QEMU (Quick Emulator) -- эмулятор аппаратного обеспечения различных платформ.
QEMU по-умолчанию использует TCG (рисунок \ref{fig:qemu-tcg}) или Tiny Code Generator (Маленький Генератор Кода) для
перевода инструкций эмулируемой системы в инструкции физической машины.

В процессе своей работы TCG разбивает поток инструкций на блоки, разделенные инструкциями
ветвления или вызова процедур.
В свою очередь, скомпилированные блоки переносятся в кэш трансляции и переиспользуются при следующих
вызовах, что ускоряет работу эмулятора.
TCG работает только с 32 и 64 битными операндами.

\begin{figure}[!htbp]
    \centering
    \input{images/qemu-tcg.tikz}
    \caption{Схема работы QEMU TCG}\label{fig:qemu-tcg}
\end{figure}

Также TCG применяет оптимизации к компилируемым блокам:
\begin{itemize}
    \item <<долгие>> инструкции заменяются на более быстрые альтернативы (если таковые имеются);
    \item производится анализ времени жизни переменных на уровне блока, при котором
          удаляются инструкции, не влияющие на вычисления.
\end{itemize}

Применение TCG позволяет запускать инструкции, предназначенные для любой поддерживаемой архитекуры
на любой другой поддерживаемой архитектуре, так как инструкции гостевой системы выполняются на виртуальных процессорах.
В случае, когда архитектура эмулируемой и физической системы совпадает, QEMU может применяться как средство виртуализации
и использовать аппаратное ускорение.
Здесь QEMU может использовать различные ускорители (гипервизоры, рисунок \ref{fig:kvm}),
отличающиеся в зависимости от операционной системы, в которой эмулятор запущен.
Гипервизор используется как <<прокладка>> для запуска некоторого программного обеспечения в виртуальной среде,
скрывая от данного программного обеспечения аппаратное обеспечение машины, на котором это ПО работает.

\begin{figure}[!htbp]
    \centering
    \input{images/kvm.tikz}
    \caption{Схема работы гипервизора KVM}\label{fig:kvm}
\end{figure}
